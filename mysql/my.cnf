# MySQL 8.0 Configuration
# Optimized for Database Observability with Grafana Alloy

[mysqld]
# =============================================================================
# Server Configuration
# =============================================================================
# Note: default_authentication_plugin was removed in MySQL 8.0.34+
# MySQL 8.0 uses caching_sha2_password by default
# To use mysql_native_password, specify it per user during user creation
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
# Note: skip-character-set-client-handshake was removed in MySQL 8.0

# =============================================================================
# Network and Connection Settings
# =============================================================================
bind-address = 0.0.0.0
port = 3306
max_connections = 200
max_connect_errors = 1000
connect_timeout = 10

# =============================================================================
# Performance Schema Settings (Required for Database Observability)
# =============================================================================
# Enable Performance Schema
performance_schema = ON

# Digest Settings (Required for query monitoring)
max_digest_length = 4096
performance_schema_max_digest_length = 4096
performance_schema_max_sql_text_length = 4096

# Statement Instrumentation
performance-schema-instrument = 'statement/%=ON'
performance-schema-consumer-events-statements-current = ON
performance-schema-consumer-events-statements-history = ON
performance-schema-consumer-events-statements-history-long = ON

# Stage Instrumentation (for query execution stages)
performance-schema-instrument = 'stage/%=ON'
performance-schema-consumer-events-stages-current = ON
performance-schema-consumer-events-stages-history = ON
performance-schema-consumer-events-stages-history-long = ON

# Wait Instrumentation (for lock analysis)
performance-schema-instrument = 'wait/%=ON'
performance-schema-consumer-events-waits-current = ON
performance-schema-consumer-events-waits-history = ON
performance-schema-consumer-events-waits-history-long = ON

# =============================================================================
# Query Cache and Logging
# =============================================================================
# Query cache is removed in MySQL 8.0, but keeping for compatibility notes
# query_cache_type = 0
# query_cache_size = 0

# Slow Query Log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/mysql-slow.log
long_query_time = 2

# General Query Log (disable in production for performance)
general_log = 0
general_log_file = /var/log/mysql/mysql-general.log

# Log queries not using indexes
log_queries_not_using_indexes = 1
log_throttle_queries_not_using_indexes = 10

# =============================================================================
# Memory and Buffer Settings
# =============================================================================
# InnoDB Buffer Pool (adjust based on available memory)
innodb_buffer_pool_size = 1G
innodb_buffer_pool_instances = 4

# Other Buffer Settings
key_buffer_size = 32M
max_allowed_packet = 64M
thread_stack = 256K
thread_cache_size = 50
sort_buffer_size = 2M
read_buffer_size = 2M
read_rnd_buffer_size = 4M
join_buffer_size = 2M
tmp_table_size = 64M
max_heap_table_size = 64M

# =============================================================================
# InnoDB Settings
# =============================================================================
innodb_file_per_table = 1
innodb_flush_log_at_trx_commit = 2
innodb_log_buffer_size = 16M
innodb_flush_method = O_DIRECT
innodb_lock_wait_timeout = 120
innodb_rollback_on_timeout = ON

# InnoDB Redo Log
innodb_redo_log_capacity = 512M

# =============================================================================
# Replication and Binary Logging
# =============================================================================
server-id = 1
log_bin = /var/log/mysql/mysql-bin.log
binlog_format = ROW
binlog_expire_logs_seconds = 604800  # 7 days
max_binlog_size = 100M
sync_binlog = 1

# =============================================================================
# Table and Query Limits
# =============================================================================
table_open_cache = 4000
table_definition_cache = 2000
open_files_limit = 8000

# =============================================================================
# Timezone
# =============================================================================
default_time_zone = '+00:00'

# =============================================================================
# SQL Modes (MySQL 8.0 defaults)
# =============================================================================
sql_mode = 'ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'

[mysql]
default-character-set = utf8mb4

[client]
default-character-set = utf8mb4
port = 3306
