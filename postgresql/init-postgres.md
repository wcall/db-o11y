# PostgreSQL Database Initialization Guide

This guide walks through initializing the PostgreSQL database with the necessary schema, tables, and permissions for the `super_awesome_application`. It also sets up the `pg_stat_statements` extension for monitoring query performance.

## Prerequisites

- Docker container `db-o11y-postgres` must be running
- Admin user credentials configured in `.env` file

---

## Step 1: Connect to PostgreSQL

Connect to PostgreSQL as the admin user:

```bash
docker exec -it db-o11y-postgres psql -U admin@admin.com -d postgres
```

---

## Step 2: Create Schema and Sample Data

### List existing databases

```sql
\l
```

### Connect to the application database

```sql
\connect super_awesome_application
```

### Create the schema

```sql
CREATE SCHEMA wcall;
```

### Create the company table

```sql
CREATE TABLE wcall.company
    (companyid int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    companyname varchar(50) NOT NULL);
```

### Insert sample data

```sql
INSERT into wcall.company (companyname) VALUES ('Grafana Labs');
INSERT into wcall.company (companyname) VALUES ('Azure');
INSERT into wcall.company (companyname) VALUES ('Amazon');
INSERT into wcall.company (companyname) VALUES ('Google');
```

### Verify the data

```sql
SELECT companyid, companyname FROM wcall.company;
```

---

## Step 3: Enable pg_stat_statements Extension

> **Reference**: [Grafana Cloud Database Observability - PostgreSQL Setup](https://grafana.com/docs/grafana-cloud/monitor-applications/database-observability/get-started/postgres/#set-up-the-postgresql-database)

### Connect to the postgres database

```sql
\connect postgres
```

### Create the extension

Repeat this across all logical databases:

```sql
CREATE EXTENSION IF NOT EXISTS pg_stat_statements;
```

### Verify the extension

Check across all logical databases:

```sql
SELECT * FROM pg_extension WHERE extname = 'pg_stat_statements';
```

### Verify query size configuration

Expected result: **4kB (4096)**

```sql
show track_activity_query_size;
```

---

## Step 4: Create db-o11y User and Grant Permissions

### Create the monitoring user

```sql
CREATE USER "db-o11y" WITH PASSWORD 'db-o11y-postgres';
```

If the user already exists, update the password:

```sql
-- ALTER USER "db-o11y" WITH PASSWORD 'db-o11y-postgres';
```

### Grant monitoring permissions

```sql
GRANT pg_monitor TO "db-o11y";
GRANT pg_read_all_stats TO "db-o11y";
```

### Exit psql

```sql
\q
```

---

## Step 5: Verify db-o11y User Access

### Connect as the db-o11y user

```bash
docker exec -it db-o11y-postgres psql -U db-o11y -d super_awesome_application
```

### List databases

```sql
\l
```

### List users

```sql
\du
```

### Test pg_stat_statements access

Run with the `db-o11y` user:

```sql
SELECT * FROM pg_stat_statements LIMIT 1;
```

### Exit psql

```sql
\q
```

---

## Step 6: Grant Schema-Level Permissions

### Connect as admin user

```bash
docker exec -it db-o11y-postgres psql -U admin@admin.com -d super_awesome_application
```

### Grant permissions on public schema

```sql
GRANT USAGE ON SCHEMA public TO "db-o11y";
GRANT SELECT ON ALL TABLES IN SCHEMA public TO "db-o11y";
```

### Grant permissions on wcall schema

```sql
GRANT USAGE ON SCHEMA wcall TO "db-o11y";
GRANT SELECT ON ALL TABLES IN SCHEMA wcall TO "db-o11y";
```

### Exit psql

```sql
\q
```

---

## Step 7: Verify Schema Access

### Connect as the db-o11y user

```bash
docker exec -it db-o11y-postgres psql -U db-o11y -d super_awesome_application
```

### Test table access

Run with the `db-o11y` user:

```sql
SELECT * FROM wcall.company;
```

### Exit psql

```sql
\q
```

---

## Step 8: Grant Global Read Permissions (Optional)

### Connect as admin user

```bash
docker exec -it db-o11y-postgres psql -U admin@admin.com -d super_awesome_application
```

### Grant read-all-data permission

This grants read access to all current and future tables:

```sql
GRANT pg_read_all_data TO "db-o11y";
```

### Verify user roles

```sql
\du
```

### Exit psql

```sql
\q
```

---

## Summary

After completing these steps, you will have:

- ✅ Created the `wcall` schema with a sample `company` table
- ✅ Enabled `pg_stat_statements` extension for query monitoring
- ✅ Created the `db-o11y` user with monitoring permissions
- ✅ Granted appropriate read permissions to the `db-o11y` user
- ✅ Verified that Grafana Alloy can query database statistics

The database is now ready for monitoring with Grafana Alloy and Database Observability!
